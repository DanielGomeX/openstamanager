{% extends "layouts/guest.twig" %}

{% block title %}{{ installing ? 'Installazione'|trans : 'Aggiornamento'|trans }}{% endblock %}

{% block box_class %}card-warning text-center{% endblock %}
{% block box_header %}
<h3 class="card-title">{{ installing ? 'Installazione di OpenSTAManager'|trans : 'Aggiornamento di OpenSTAManager'|trans }}</h3>
{% endblock %}

{% block content %}
    {% if installing %}
    <p><strong>{{ "E' la prima volta che avvii OpenSTAManager e non hai ancora installato il database"|trans }}.</strong></p>
    {% else %}
    <p>{{ "E' necessario aggiornare il database a una nuova versione"|trans }}.</p>
    {% endif %}

    {% set button = installing ? 'Installa!'|trans : 'Aggiorna!'|trans %}

    <p>{{ "Premi il tasto _BUTTON_ per procedere con l'_OP_!"|trans({
        '_BUTTON_': '<b>' ~ button ~ '</b>',
        '_OP_': installing ? 'installazione'|trans : 'aggiornamento'|trans,
        })|raw }}</p>
    <input type="button" class="btn btn-primary" value="{{ button }}" onclick="continue_update()" id="contine_button">

    <script>
        function continue_update(){
            swal({
                title: "{{ 'Sei sicuro di voler procedere?'|trans }}",
                text: "",
                type: "warning",
                showCancelButton: true,
                confirmButtonClass: "btn btn-lg btn-success",
                confirmButtonText: "{{ 'Procedi'|trans }}",
            }).then(function(){
                $("#progress").show();
                $("#result").load("{{ path_for('update-progress') }}");
                $("#contine_button").remove();
            }, function(){});
        }
    </script>

    <div id="progress">
        <div class="progress">
            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%">
                <span>0%</span>
            </div>
        </div>
        <hr>
        <div class="card card-outline card-info text-center collapsed-box">
            <div class="card-header">
                <h3 class="card-title"><a class="clickable" data-card-widget="collapse">{{ 'Log'|trans }}</a></h3>
                <div class="card-tools float-right">
                    <button type="button" class="btn btn-card-tool" data-card-widget="collapse"><i class="fa fa-plus"></i></button>
                </div>
            </div>
            <div class="card-body info text-left"></div>
        </div>
    </div>
    <div id="result"></div>

    <div style="display: none;" id="completed">
        <p><strong>{{ 'Aggiornamento completato'|trans }}</strong> <i class="fa fa-smile-o"></i></p>

        {% if installing %}
            <!-- Istruzioni per la prima installazione -->
            <p class="text-danger">{{ "E' fortemente consigliato rimuovere i permessi di scrittura dal file _FILE_"|trans({'_FILE_': '<b>config.inc.php</b>'})|raw }}.</p>
        {% endif %}

        <a class="btn btn-success btn-block" href="{{ path_for('login') }}">
            <i class="fa fa-check"></i> {{ 'Continua'|trans }}
        </a>
    </div>

    <script>
        let count, current, progress, percent, total, versions;

        $(document).ready(function(){
            $(".login-box").fadeOut();

            count = {{ total_updates }};
            current = 0;
            versions = [];

            progress = 0;
            total = {{ total_count }};
        });

        function addProgress(rate){
            progress += rate;
            percent = progress / total * 100;
            percent = Math.round(percent);
            percent = percent > 100 ? 100 : percent;

            setPercent(percent);
        }

        function setPercent(percent){
            $("#progress .progress-bar").width(percent + "%");
            $("#progress .progress-bar span").text(percent + "%");

            console.log(percent);
            if (percent >= 100){
                $("#completed").show();
            }
        }

        function addVersion(version){
            if(versions.indexOf(version) === -1){
                versions.push(version);
                current += 1;

                $("#progress .info").html($("#progress .info").html() + "<p><strong>{{ 'Aggiornamento _DONE_ di _TODO_ (_VERSION_)'|trans({
                    '_DONE_': '" + current + "',
                    '_TODO_': '" + count + "',
                    '_VERSION_': '" + version.trim() + "',
                })|raw }}</strong></p>");
            }
        }
    </script>
{% endblock %}
