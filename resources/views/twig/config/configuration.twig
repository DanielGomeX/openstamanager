{% extends "layouts/guest.twig" %}

{% block title %}{{ "Configurazione"|trans }}{% endblock %}

{% block box_class %}card-warning{% endblock %}
{% block box_header %}
<img src="{{ base_url() }}/assets/img/logo.png" class="logo-image" alt="{{ 'OSM Logo'|trans }}">
<h3 class="card-title">{{ "Configurazione per l'installazione"|trans }}</h3>
{% endblock %}

{% block content %}
    <!-- Controlli per essere sicuro che l'utente abbia letto la licenza -->
    <script>
    $(document).ready(function(){
        let wizard = $(".card-body");

        wizard.smartWizard({
            useURLhash: false,
            showStepURLhash: false,
            theme: "default",
            transitionEffect: "slideLeft",
            lang : {
                next: "{{ 'Successivo'|trans }}",
                previous: "{{ 'Precedente'|trans }}",
            }
        });

        wizard.on("leaveStep", function(e, anchorObject, stepNumber, stepDirection) {
            result = true;
            if(stepDirection == "forward" && $("#step-" + (stepNumber + 1) + " form").length){
                result = $("#step-" + (stepNumber + 1) + " form").parsley().validate();
            }

            if(!result){
                swal("{{ 'Impossibile procedere'|trans }}", "{{ 'Prima di proseguire devi completare i campi obbligatori!'|trans }}", "error");
            }

            $("html, body").animate({ scrollTop: $("#steps").offset().top }, 500);

            return result;
        });

        $("#install").on("click", function(){

            if($(this).closest("form").parsley().validate()){
                prev_html = $("#install").html();
                $("#install").html("<i class='fa fa-spinner fa-pulse fa-fw'></i> {{ 'Attendere'|trans }}...");
                $("#install").prop('disabled', true);
                $("#test").prop('disabled', true);

                $("#config-form").submit();
            }

        });

        $("#test").on("click", function(){
            if($(this).closest("form").parsley().validate()){
                prev_html = $("#test").html();
                $("#test").html("<i class='fa fa-spinner fa-pulse fa-fw'></i> {{ 'Attendere'|trans }}...");
                $("#test").prop('disabled', true);
                $("#install").prop('disabled', true);
                $(this).closest("form").ajaxSubmit({
                    url: '{{ path_for('configuration-test') }}',
                    data: {
                        test: 1,
                    },
                    type: "post",
                    success: function(data){
                        data = parseFloat(data.trim());

                        $("#test").html(prev_html);
                        $("#test").prop('disabled', false);
                        $("#install").prop('disabled', false);

                        if(data == 0){
                            swal("{{ 'Errore della configurazione'|trans }}", "{{ 'La configurazione non è corretta'|trans }}.", "error");
                        } else if(data == 1){
                            swal("{{ 'Permessi insufficienti'|trans }}", "{{ "L'utente non possiede permessi sufficienti per il testing della connessione. Potresti rilevare problemi in fase di installazione."|trans }}.", "error");
                        } else {
                            swal("{{ 'Configurazione corretta'|trans }}", "{{ 'Ti sei connesso con successo al database'|trans }}. {{ "Clicca su 'Installa' per proseguire"|trans }}.", "success");
                        }
                    },
                    error: function(xhr, error, thrown) {
                        ajaxError(xhr, error, thrown);
                    }
                });
            }
        });
    });
    </script>

    <ul>
        <span class="pull-right col-md-4">
            <select class="form-control hide" id="language" required="1">
    {% for code, language in languages %}
                <option data-country="{{ language['flag'] }}" value="{{ code }}" {{ code == lang ? 'selected' : '' }}>{{ language['title'] }}</option>';
    {% endfor %}
            </select>

            <script>
            var flag_link = "https://lipis.github.io/flag-icon-css/flags/4x3/|flag|.svg";

            $(document).ready(function() {
                $.ajax({
                    url: flag_link.replace("|flag|", "it"),
                    success: function(){
                        initLanguage(true);
                    },
                    error: function(){
                        initLanguage(false);
                    },
                    timeout: 500
                });
            });

            function initLanguage(flag) {
                $("#language").removeClass("hide");

                $("#language").select2({
                    theme: "bootstrap",
                    templateResult: function(item) {
                        if (!item.id || !flag) {
                            return item.text;
                        }

                        var element = $(item.element);
                        var img = $("<img>", {
                            class: "img-flag",
                            width: 26,
                            src: flag_link.replace("|flag|", element.data("country").toLowerCase()),
                        });

                        var span = $("<span>", {
                            text: " " + item.text
                        });
                        span.prepend(img);

                        return span;
                    }
                });

                $("#language").on("change", function(){
                    if ($(this).val()) {
                        var location = window.location;
                        var url = location.protocol + "//" + location.host + "" + location.pathname;

                        var parameters = getUrlVars();
                        parameters.lang = $(this).val();

                        redirect(url, parameters);
                    }
                });
            }
            </script>
        </span>

        <li><a href="#step-1">
            <h3>{{ 'Licenza'|trans }}</h3>
        </a></li>

        <li><a href="#step-2">
            <h3>{{ 'Configurazione'|trans }}</h3>
        </a></li>
    </ul>

    <div id="steps">

        <!-- LICENZA -->
        <div id="step-1">
            <p>{{ 'OpenSTAManager è tutelato dalla licenza _LICENSE_!'|trans({'_LICENSE_': 'GPL 3.0'}) }}</p>

            <div class="row">
                <div class="col-md-8">
                    <span class="float-left" title={{ 'Visiona e accetta la licenza per proseguire'|trans }} >{{ 'Accetti la licenza GPLv3 di OpenSTAManager?'|trans }}*</span>
                </div>

                <form class="col-md-4">
                    <input type="checkbox" id="agree" name="agree" data-parsley-required="true">
                    <label for="agree">{{ 'Ho visionato e accetto'|trans }}.</label>
                </form>
            </div>
            <hr>

            <textarea class="form-control autosize" rows="15" readonly>{{ license }}</textarea><br>
            <a class="float-left" href="https://www.gnu.org/licenses/translations.en.html#GPL" target="_blank">[ {{ 'Versioni tradotte'|trans }} ]</a><br><br>
        </div>

        <!-- PARAMETRI -->
        <div id="step-2">
            <a href="https://www.openstamanager.com/contattaci/?subject=Assistenza%20installazione%20OSM" target="_blank" ><img class="float-right" width="32" src="{{ base_url() }}/assets/img/help.png" alt="{{ 'Aiuto'|trans }}" title="{{ 'Contatta il nostro help-desk'|trans }}"/></a>

            <p>{{ 'Non hai ancora configurato OpenSTAManager'|trans }}.</p>
            <p><small class="form-text">{{ 'Configura correttamente il software con i seguenti parametri (modificabili successivamente dal file _FILE_)'|trans({'_FILE_': '<b>config.inc.php</b>'})|raw }}</small></p>

            <!-- Form dei parametri -->
            <form action="" method="post" id="config-form">
                <input type="hidden" name="lang" value="{{ lang}}">

                <h4>{{ 'Formato date'|trans }}</h4>
                <div class="row">
                    <div class="col-md-4">
                        {[ "type": "text", "label": "{{ 'Formato data lunga'|trans }}", "name": "timestamp_format", "value": "d/m/Y H:i", "required": 1 ]}
                    </div>

                    <div class="col-md-4">
                        {[ "type": "text", "label": "{{ 'Formato data corta'|trans }}", "name": "date_format", "value": "d/m/Y", "required": 1 ]}
                    </div>

                    <div class="col-md-4">
                        {[ "type": "text", "label": "{{ 'Formato orario'|trans }}", "name": "time_format", "value": "H:i", "required": 1 ]}
                    </div>
                </div>

                <small>'{{ 'I formati sono impostabili attraverso lo standard previsto da PHP: _LINK_'|trans({'_LINK_': '<a href="https://www.php.net/manual/en/function.date.php#refsect1-function.date-parameters">https://www.php.net/manual/en/function.date.php#refsect1-function.date-parameters</a>'}) }}.</small>
                <hr>

                <h4>{{ 'Database'|trans }}</h4>
                <div class="row">

                    <!-- db_host -->
                    <div class="col-md-12">
                        {[ "type": "text", "label": "{{ 'Host del database'|trans }}", "name": "host", "placeholder": "{{ "Indirizzo dell'host del database"|trans }}", "value": "{{ host }}", "help": "{{ 'Esempio'|trans }}: localhost", "show-help": 0, "required": 1 ]}
                    </div>
                </div>

                <div class="row">

                    <!-- db_username -->
                    <div class="col-md-4">
                        {[ "type": "text", "label": "{{ "Username dell'utente MySQL"|trans }}", "name": "username", "placeholder": "{{ "Username"|trans }}", "value": "{{ username }}", "help": "{{ 'Esempio'|trans }}: root", "show-help": 0, "required": 1 ]}
                    </div>

                    <!-- db_password -->
                    <div class="col-md-4">
                        {[ "type": "password", "label": "{{ "Password dell'utente MySQL"|trans }}", "name": "password", "placeholder": "{{ "Password"|trans }}", "value": "{{ password }}", "help": "{{ 'Esempio'|trans }}: mysql", "show-help": 0 ]}
                    </div>

                    <!-- db_name -->
                    <div class="col-md-4">
                        {[ "type": "text", "label": "{{ 'Nome del database'|trans }}", "name": "database_name", "placeholder": "{{ 'Database'|trans }}", "value": "{{ database_name }}", "help": "{{ 'Esempio'|trans }}: openstamanager", "show-help": 0, "required": 1 ]}
                    </div>
                </div>

                <!-- PULSANTI -->
                <div class="row">
                    <div class="col-md-4">
                        <span>*<small><small>{{ 'Campi obbligatori'|trans }}</small></small></span>
                    </div>
                    <div class="col-md-4 text-right">
                        <button type="button" id="test" class="btn btn-warning btn-block">
                            <i class="fa fa-file-text"></i> {{ 'Testa il database'|trans }}
                        </button>
                    </div>
                    <div class="col-md-4 text-right">
                        <button type="submit" id="install" class="btn btn-success btn-block">
                            <i class="fa fa-check"></i> {{ 'Installa'|trans }}
                        </button>
                    </div>
                </div>

            </form>
        </div>

    </div>

{% endblock %}
