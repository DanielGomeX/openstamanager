{% extends "module.twig" %}

{% block top_content %}
    <!-- Widget in alto -->
    {( "name": "widgets", "id_module": "{{ module_id }}", "id_record": "{{ record_id }}", "position": "top", "editor": "controller" )}

    {% if setting('Attiva notifica di presenza utenti sul record') %}
        <div class="box box-warning box-solid text-center info-active hide">
            <div class="box-header with-border">
                <h3 class="box-title"><i class="fa fa-warning"></i> {{ 'Attenzione!'|trans }}</h3>
            </div>
            <div class="box-body">
                <p>{{ 'I seguenti utenti stanno visualizzando questa pagina'|trans }}:</p>
                <ul class="list">
                </ul>
                <p>{{ 'Prestare attenzione prima di effettuare modifiche, poich√® queste potrebbero essere perse a causa di multipli salvataggi contemporanei'|trans }}.</p>
            </div>
        </div>
    {% endif %}
{% endblock %}

{% block module_content %}

    <!--  Pulsanti di default -->
    <div id="pulsanti">
        <a class="btn btn-warning" href="{{ path_for('module', {'module_id': module_id}) }}">
            <i class="fa fa-chevron-left"></i> {{ "Torna all'elenco"|trans }}
        </a>

        <div class="pull-right">
            {( "name": "button", "type": "print", "id_module": "{{ module_id }}", "id_record": "{{ record_id }}" )}

            {( "name": "button", "type": "email", "id_module": "{{ module_id }}", "id_record": "{{ record_id }}" )}

            <a class="btn btn-success" id="save">
                <i class="fa fa-check"></i> {{ 'Salva'|trans }}
            </a>
        </div>
    </div>

    <script>
        $(document).ready(function(){
            var form = $("#module-edit").find("form").first();

            // Aggiunta del submit
            form.prepend('<button type="submit" id="submit" class="hide"></button>');

            $("#save").click(function(){
                $("#submit").trigger("click");
            });

            // Pulsanti dinamici
            if (!isMobile()) {
                $("#pulsanti").affix({
                    offset: {
                        top: 200
                    }
                });

                if ($("#pulsanti").hasClass("affix")) {
                    $("#pulsanti").css("width", $("#tab_0").css("width"));
                }

                $("#pulsanti").on("affix.bs.affix", function(){
                    $("#pulsanti").css("width", $("#tab_0").css("width"));
                });

                $("#pulsanti").on("affix-top.bs.affix", function(){
                    $("#pulsanti").css("width", "100%");
                });
            }

        });
    </script>

    <div class="clearfix"></div>
    <br>

    <div class="pull-right" id="pulsanti-modulo">
        {% block buttons %}{% endblock %}
    </div>

    <div class="clearfix"></div>
    <br>

    <div id="module-edit">
        {% block editor_content %}{% endblock %}
    </div>

    <!-- Campi personalizzati -->
    <div class="hide" id="custom_fields_top-edit">
        {( "name": "custom_fields", "id_module": "{{ module_id }}", "id_record": "{{ record_id }}", "position": "top" )}
    </div>

    <div class="hide" id="custom_fields_bottom-edit">
        {( "name": "custom_fields", "id_module": "{{ module_id }}", "id_record": "{{ record_id }}" )}
    </div>

    <script>
        $(document).ready(function(){
            var form = $("#custom_fields_top-edit").parent().find("form").first();

            // Campi a inizio form
            form.prepend($("#custom_fields_top-edit").html());

            // Campi a fine form
            var last = form.find(".panel").last();

            if (!last.length) {
                last = form.find(".box").last();
            }

            if (!last.length) {
                last = form.find(".row").eq(-2);
            }

            last.after($("#custom_fields_bottom-edit").html());
        });
    </script>
{% endblock %}


{% block bottom_content %}
    <!-- Widget in alto -->
    {( "name": "widgets", "id_module": "{{ module_id }}", "id_record": "{{ record_id }}", "position": "right", "place": "editor" )}

    <hr>
    <a class="btn btn-default" href="{{ path_for('module', {'module_id': module_id}) }}">
        <i class="fa fa-chevron-left"></i> {{ 'Indietro'|trans }}
    </a>

    <script>
        // Se l'utente ha i permessi in sola lettura per il modulo, converto tutti i campi di testo in span
        {% set read_only = structure.permission == 'r' %}
        {% set not_class = read_only ? '' : '.not(".unblockable")' %}
        {% if read_only or (block_edit is defined and block_edit == false) %}
        $(document).ready(function(){
            $("input, textarea, select", "section.content"){{ not_class|raw }}.attr("readonly", "true");
            $("select, input[type=checkbox]", "section.content"){{ not_class|raw }}.prop("disabled", true);

            {% if read_only %}
            $("a.btn, button, input[type=button], input[type=submit]", "section.content").hide();
            $("a.btn-info, a.btn-warning, button.btn-info, button.btn-warning, input[type=button].btn-info", "section.content").show();
            {% endif %}

        });
        {% endif %}

        var content_was_modified = false;

        // controllo se digito qualche valore o cambio qualche select
        $("input, textarea, select").bind("change paste keyup", function(event) {
            if( event.keyCode >= 32 ){
                content_was_modified = true;
            }
        });

        // tolgo il controllo se sto salvando
        $(".btn-success, button[type=submit]").bind("click", function() {
            content_was_modified = false;
        });

        $( "form" ).bind( "submit", function() {
            content_was_modified = false;
        });

        // questo controllo blocca il modulo vendita al banco, dopo la lettura con barcode, appare il messaggio di conferma
        window.onbeforeunload = function(e){
            if(content_was_modified) {
                var dialogText = "{{ "Uscire senza salvare?"|trans }}";
                e.returnValue = dialogText;
                $("#main_loading").fadeOut();
                return dialogText;
            }
        };

        window.addEventListener("unload", function(e) {
            $("#main_loading").show();
        });

        function getActiveUsers(){
            $.getJSON('<?php echo ROOTDIR; ?>/ajax.php?op=active_users', {
                    id_module: {{ module_id }},
                    id_record: {{ record_id }},
                },
                function(data) {
                    if (data.length != 0) {
                        $(".info-active").removeClass("hide");
                        $(".info-active .list").html("");
                        $.each( data, function( key, val ) {
                            $(".info-active .list").append("<li>"+val.username+"</li>");
                        });
                    }
                    else $(".info-active").addClass("hide");
                });
        }

        {% if setting('Attiva notifica di presenza utenti sul record') %}
        getActiveUsers();

        setInterval(getActiveUsers, {{ setting('Timeout notifica di presenza (minuti)') }} * 60 * 1000);
        {% endif %}
    </script>
{% endblock %}
