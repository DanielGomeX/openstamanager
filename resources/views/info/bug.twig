{% extends "layouts/app.twig" %}

{% block title %}{{ "Bug"|trans }}{% endblock %}

{% block content %}
    {% if mail.from_address is empty or mail.serve is empty %}
<div class="alert alert-warning">
    <i class="fa fa-warning"></i>
    <b>{{ 'Attenzione!'|trans }}</b> {{ 'Per utilizzare correttamente il modulo di segnalazione bug devi configurare alcuni parametri riguardanti le impostazione delle email'|trans }}.

    {{ module('Account email').link(mail['id'], 'Correggi account'|trans, null, 'class="btn btn-warning float-right"')|raw }}
    <div class="clearfix"></div>
</div>
{% endif %}

<div class="card card-outline card-primary">
    <div class="card-header">
        <h3 class="card-title"><i class="fa fa-bug"></i> {{ 'Segnalazione bug'|trans }}</h3>
    </div>

    <div class="card-body">
        <form method="post" action="">
            <input type="hidden" name="op" value="send">

            <table class="table table-bordered table-condensed table-striped table-hover">
                <tr>
                    <th width="150" class="text-right">{{ 'Da'|trans }}:</th>
                    <td>{{ mail['from_address'] }}</td>
                </tr>

                <!-- A -->
                <tr>
                    <th class="text-right">{{ 'A'|trans }}:</th>
                    <td>{{ bug_email }}</td>
                </tr>

                <!-- Versione -->
                <tr>
                    <th class="text-right">{{ 'Versione OSM'|trans }}:</th>
                    <td>{{ version }} ({{ revision ? revision : 'In sviluppo'|trans }})</td>
                </tr>
            </table>

            <div class="row">
                <div class="col-md-4">
                    {[ "type": "checkbox", "placeholder": "{{ 'Allega file di log'|trans }}", "name": "log", "value": "1" ]}
                </div>

                <div class="col-md-4">
                    {[ "type": "checkbox", "placeholder": "{{ 'Allega copia del database'|trans }}", "name": "sql" ]}
                </div>

                <div class="col-md-4">
                    {[ "type": "checkbox", "placeholder": "{{ 'Allega informazioni sul PC'|trans }}", "name": "info", "value": "1" ]}
                </div>
            </div>

            <div class="clearfix"></div>
            <br>

            {[ "type": "ckeditor", "label": "{{ 'Descrizione del bug'|trans }}", "name": "body" ]}

            <!-- PULSANTI -->
            <div class="row">
                <div class="col-md-12 text-right">
                    <button type="submit" class="btn btn-primary" id="send" disabled>
                        <i class="fa fa-envelope"></i> {{ 'Invia segnalazione'|trans }}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
    $(document).ready(function(){
        var editor = editors.body;

        // Impostazione del messaggio
        var html = `<p>{{ 'Se hai riscontrato un bug ricordati di specificare'|trans }}:</p>
            <ul>
                <li>{{ 'Modulo esatto (o pagina relativa) in cui questi si Ã¨ verificato'|trans }};</li>
                <li>{{ 'Dopo quali specifiche operazioni hai notato il malfunzionamento'|trans }}.</li>
            </ul>
            <p>{{ "Assicurati inoltre di controllare che il checkbox relativo ai file di log sia contrassegnato, oppure riporta qui l'errore visualizzato"|trans }}.</p>
            <p>{{ 'Ti ringraziamo per il tuo contributo'|trans }},<br>
            {{ 'Lo staff di OSM'|trans }}</p>`;
        var firstFocus = 1;

        editor.setData(html);
        editor.editing.view.document.on('change:isFocused', ( evt, name, value ) => {
            if(firstFocus){
                editor.setData("");
                firstFocus = 0;
            }
        });

        // Blocco pulsante di invio
        editor.model.document.on('change:data', () => {
            if(editor.getData() == ""){
                $("#send").prop("disabled", true);
            }
            else $("#send").prop("disabled", false);
        });
    });
</script>
{% endblock %}
